groups:
  - name: telegram_bot_alerts
    rules:
      # Алерт по высокому количеству ошибок
      - alert: HighErrorRate
        expr: rate(telegram_bot_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Высокий уровень ошибок в Telegram боте"
          description: "Уровень ошибок {{ $value }} ошибок в секунду в течение последних 5 минут"

      # Алерт по высокому использованию памяти
      - alert: HighMemoryUsage
        expr: telegram_bot_memory_usage_bytes > 500000000 # 500MB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Высокое использование памяти"
          description: "Использование памяти: {{ $value | humanize }}B"

      # Алерт по критическому использованию памяти
      - alert: CriticalMemoryUsage
        expr: telegram_bot_memory_usage_bytes > 1000000000 # 1GB
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Критическое использование памяти"
          description: "Использование памяти: {{ $value | humanize }}B"

      # Алерт по большому количеству горутин
      - alert: HighGoroutineCount
        expr: telegram_bot_goroutines_count > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Большое количество горутин"
          description: "Количество горутин: {{ $value }}"

      # Алерт по проблемам с базой данных
      - alert: DatabaseConnectionIssues
        expr: increase(telegram_bot_database_operations_total{status="error"}[5m]) > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Проблемы с подключением к базе данных"
          description: "{{ $value }} ошибок базы данных за последние 5 минут"

      # Алерт по низкой активности (бот может быть недоступен)
      - alert: LowActivity
        expr: rate(telegram_bot_requests_total[10m]) < 0.01
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Низкая активность бота"
          description: "Менее {{ $value }} запросов в секунду за последние 10 минут"

      # Алерт по неудачным уведомлениям
      - alert: NotificationFailures
        expr: rate(telegram_bot_notifications_sent_total{status="error"}[5m]) > 0.05
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Ошибки отправки уведомлений"
          description: "{{ $value }} неудачных уведомлений в секунду"

      # Алерт по высокому времени ответа
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(telegram_bot_http_request_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Высокое время ответа"
          description: "95-й перцентиль времени ответа: {{ $value }}s"

      # Алерт по недоступности health check
      - alert: HealthCheckFailing
        expr: up{job="telegram-queue-bot"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Telegram бот недоступен"
          description: "Health check не отвечает более 1 минуты"
